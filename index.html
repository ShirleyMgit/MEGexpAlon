<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Memory Experiment</title>

  <!--CSS style-->
  <link rel="stylesheet" type="text/css" href="firstExp9.css">

  <!--required libraries-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

  <!-- tasks part functions-->
  <script src="graph.js"></script><!--define maps dimentions and missing links-->
  <script src="rectGA.js"></script><!--create rectangular transition matrix-->
  <script src="createMissLinkArGen.js"></script><!-- missing links array-->
  <script src="otherFunKeyFor.js"></script><!--helper functions-->
  <script src="learnRandomWalk.js"></script><!--learning phase - learn from random walk (consecutive pairs). previously called cover-->
  <script src="learnRandomPairs.js"></script><!--learning phase - learn from random (non-consecutive) pairs. previously called coverPair-->
  <script src="isMiddle_missingLink.js"></script><!--is it in the middle task-->
  <script src="selPileNotTwice.js"></script><!--pile task-->
  <script src="taskNavig.js"></script><!--navigation task-->
  <script src="whereToGo.js"></script><!-- distance estimation task-->
  <script src="ajaxFunctions.js"></script>
</head>

<body>
<!--start-->

<!--subject details:-->
<center><div id="startDiv" style="background-color: powderblue;">
  <p style="font-size: 20px"><b>Welcome</b><br> please enter your details.</p>
  Prolific subject ID (or your full name if you don't have a subject ID):<br> <input type="text" id="subjectId" value="" ><br><br>
  <!--when pressing "click when ready to start", call initMapsAndSetDisplay() [] which will look
  for tables for this subject, and if they don't exist, create them.-->
  <button onclick="initMapsAndSetDisplay()" style="background-color:MediumOrchid "><b>Click when ready to start</b></button>
  <p id = "ms" style="font-size: 20px">The task will start soon<br>(please do not refresh the page - this can take up to 20 seconds).</p>
</div> </center>

<!--task description:-->

<div class="global inst">
  <p id="inst1"></p>
  <button type="button" id="startTb"
  onclick="choosePart()">Start Task</button>
</div>

<!-- Passive learning from consecutive pairs of stimuli (random walk) -->

<div id="learnRandomWalk">

  <center><div><p class="centerC" id="instructions"> </p>
    <img id="chPicCold"><img id="chPicC1">
  </div></center>

  <center><div style="padding-bottom: 4%;"class="pic" id="pic1";>
  </div></center>

  <center><p id = "newM"></p></center>

  <button type="button" id = "qBot"
  onclick="endAllTrials_learnRandomWalk(1)">Next Part</button>
</div>

<!--Passive learning from random (non-consecutive) pairs of stimuli-->

<div id="learnRandomPairs">

  <center><div><p class="centerP" id="instructionsP"> </p>
    <img id="PicPC1"><img id="PicPC2">
  </div></center>

  <center><div><p id="conCP">...</p></center>
    <center><div style="padding-bottom: 8%;"class="pic" id="pic1";>
    </div></center>

    <center><p id = "newMP"></p></center>

  </div>


  <!--pile task-->

  <div class="pileDiv">
    <p id="pileIns">The following card will appear in one of the 2 piles,<br> it can appear in the pile if it is associated to the last card that appears on the pile. <br>A card cannot appear twice on the same pile.<br> Can the card appear on the first or second pile? (click 1, 2 or 3 for both)</p>
    <img id="wCp" style="position:relative; bottom:50px;  left:685px;">
    <center><div><p id="isCorRSp" style="position:relative; bottom:60px; left:200px;"></p><p id="EconSp" style="position:relative; bottom:40px; left:70px; font-size:14px;">press ENTER to continoue</p></div></center>
    <center><div id="allPic" style="display:block; position:relative; bottom:40px;">
      <div id="pile1" style="display:block">
        <img id="imCp11"><p></p>
        <img id="imCp12" style="position:relative; bottom:40px; left:20px;"><p></p>
        <img id="imCp13" style="position:relative; bottom:80px; left:40px;"><p></p>
        <img id="imCp14" style="position:relative; bottom:120px; left:60px;"><p></p>
      </div>
      <div id="pile2" style="display:block; position:relative; bottom:530px; left:200px;">
        <img id="imCp21"><p></p>
        <img id="imCp22" style="position:relative; bottom:40px; left:20px;"><p></p>
        <img id="imCp23" style="position:relative; bottom:80px; left:40px;"><p></p>
        <img id="imCp24" style="position:relative; bottom:120px; left:60px;"><p></p>
      </div>
    </div></center>
    <!--<p id="EconSp" style="position:absolute; bottom:200px; left:200px;" >press <b>Enter<b> to continoue</p>-->
    <button type="button" id="nextSp" onclick="writeRresSp()">Next Step</button>
  </div>

  <!--is middle task-->
  <div class="isMiddle">
    <center><p style="font-size: 22px">Can the card in the middle appear between the following first and third cards?</br> A card can appear in the middle only if it is associated to the 2 cards<br> Whether the first and third cards are associated to one another or not is not important. <br> <b>press y/n</b></p></center>
    <center><div id="im1d"><p>third card</p><img id="im1"></div>
      <div id="im2d"><p>first card</p><img id="im2"></div>
    </center>
    <center><p id="im3cor" style="font-size: 18px; color:red"></p></center>
    <center><p id="im3con">Press <b>Enter</b> to continoue</p></center>
    <center><div id="im3div"><p id="im3p"><br>Intermediate Card?</p><img id="im3"></div></center>

    <button type="button" id="nextIsM" ;
    onclick="writeResp()">Next Step</button>
  </div>

  <!-- Navigation Task:-->

  <div class="navig">

    <!--  define instructions block -->
    <p class="centerC" id="instructionsT"> </p><p id="instructionsT2"> </p>

    <center><p id="dispPc">press ENTER to continue</p></center>
    <center><p id="skip">press ENTER to skip</p></center>
    <center><div id="tarPid"><p id="targetPic"></p><img id="tarPt"></div></center>
    <center><div id="cPic"><p id="startPic"></p><img id="currPt"></div></center>
    <center><div id="picT">

      <img id="chPic1"/>
      <img id="chPic2"/>

    </div> </center>


    <center> <div class="endTask"><p id="endExpReachT"></p>
      <button type="button" id = "conBot"
      onclick="contT(1)">
      click here to continue to next session</button>
      <button type="button" id = "endBot"
      onclick="endAllTrials_navig(1)">
      click to Finish</button>
    </div></center>
  </div>

  <!--the coins-->
  <canvas id="myCanvas" width="450" height="450" ></canvas>
  <p id="nCoinP" style="position:fixed; bottom:10px; right:180px;color:blue"></p>

  <center><p id="endThanksT"></p></center>
  <div id="LbotT" ></div> <div id="RbotT"></div>

  <!-- Which is closer (previously called Where to Go or distnce estimation task)-->

  <div class="whichIsCloser">

    <!--  define instructions block -->
    <p class="centerC" id="instructionsQ"> </p>

    <center><div id="tarPidQ"><p id="targetPicQ"></p><img id="tarPQ"></div></center>

    <center><div id="im1Q"><p>CARD 1</p><img id="Q1"></div></center>
    <center><div id="im2Q"><p>CARD 2</p><img id="Q2"></div></center>


    <center><p id="iqcor" style="font-size: 20px; color:red"></p></center>
    <center><p id="iqcon">Press <b>Enter</b> to continue</p></center>

  </div>

  <center><div class="whichIsCloser_feedback">
    <p id="Qfeedback"></p>
    <button type="button" id="nextBlock"
    onclick="chooseLearning_walkOrPairs(0)">Continue</button>
  </div></center>



<!-- **********************   begin javascript script   ********************-->

<script>
/* the task is organised such that there are 8 learning runs (each is a cycle of all tasks)
of 2 maps and 7 inference runs of a third map*/

initRand(); // Alon: this fuction doesn't output anything - delete?

// initialise task object.
var task = {}
// current run of the entire task. e.g. when some parts have completed x+1 runs and others
// completed x, task.curRun = x+1. Starts counting from 1, not 0.
task.curRun = 0;
task.mapsVec = [0,0,0,0,1,1,1,1,2,2,2,2,2,2,2]; //defines the map of each run, 0&1 training, 2 - inference


// parts (tasks) objects - these will be useful to have better control over global variables

class partObj {
  constructor() {
    this.trial = -1 // current trial. if not currently playing this task part, set to -1. start counting (first trial) from 1, not 0).
  }
}

let learnWalkObj = new partObj
// number of trials in each run. previously called maxCov or maxCovH. for cluster graph, used to be 180 (maxCovC)
learnWalkObj.maxTrial = 120;

let learnPairsObj = new partObj
// number of trials in each run. previously called maxCovP.
learnPairsObj.maxTrial = 150;

let pileObj = new partObj
let middleObj = new partObj
let navigObj = new partObj
let whichCloserObj = new partObj


/* variable to change */
var isNestDis=0;//disable the next button if equal 1
/*training structural form*/
var typeAr="recA";//"HexA";//"clA";//
/*vriables that are specific to the adjacency matrix:*/
/* graph dimensions are defined in the function defineGraph below*/
var nRow;
var nCol;
var nb;//number of neighbours
var np;// the number of pictures
var maxMap = 3;// number of maps
var npmax=36;// maximal number of pictures in an array (map)
var vnmis; // mising links nodes
var vConmis;// the nodes that are connected to the nodes of the missing links nodes

var nT0 = 7;
var nT1 = 15;
var curMp = -1;// current map
var maxdS = 4;
var qend = 24;//20;//45;//34 - mis, 11 regular. number of distance estimation questions
var ncycle = 4;//number of cycles per set
/* parameters for cluster Arch fixed neighbors*/
var nc = 5;// number of clusters in the community structure graph
var ninc = 7;// number of nodes in each cluster
var Ar,DistM,ArMiss;// transition matrix and distance estimation
var flagNR1 = 1;//number of cycle of 2 maps - 2 cycle per map
var flagNR2 = 1;//number of cycle of 2 maps - 2 cycle per map
var NumRep=2;
var maxRoundH = 4;
var maxRoundC = 5;
var maxTask = 200;// maximum number of steps in the distance estimation task
var maxT = task.mapsVec.length;//NumRep*maxRound*maxMap +maxRound*maxMap/2;
var nRepTask = 3;
var numdS=3;
var dsMin = 2;
var numCorrect;//number of correct responses in distance estimation questions
/*max displays during the learning phase in each block*/

var maxIsM=15;//10;
var maxPile = 15;

var pileAr;
var dS;//the initial distance in the navigation task
/*File Name*/
var writeFile;
var payFile;
var mapFile;
var presntFile;
/*general parameters*/
var sz = 20;//cycle size
var flagC=0,y = 425,dy=0.9*sz;//cirlce height
var x = -5,dx=sz*2+5;
var y0 = y;//intial hight for the cycles
var maxCoin = 140;//maximum number of coins that can be earn in each part
var minTr = 0;//minimum trial to activate the "next" button
var ncoin=0;
var nSD = 2;//number of trials in which distance is given
var nall=50;//number of pictures in the directory;
var nstruct = 2;//number of different map with the same structure
var nnT;//which structure should be used
var twait=500;
var stType;
var ncolCrc=1;
var cgetR = 0.4;
var thisTC=-1;

/* pictures button objects*/
var pathToImgDir;

/*respone ojsect*/
var resCArr=[];//the array of resCover
var resTArr=[];//the array of resTASK
var resIsMArr=[];//the array of IsItMiddle Task
var resSpArr=[];//the array of which pile Task

/*trial variable*/
var isFround = 1;
var nRunsNavig = 0;
var numQ = 0;
var flagSp=2;
var flagMV=5;
var flagSs=-1;
var flagIsM = 9;
var flagCov = 0;
var flagCovP = 0;
var flagQ=-1;
var timeLast,timeLast_sec,timeLast_min,timeLast_hr;//to track response time
var endR=0;
var c,cend,flagSs,corR=0;
var inP1,inP,inPr;
var dtT;
var stTarr;
var flip =0;
var imgFileNamesArr=[]; // the pictures from directory array


/*disable the end bottuns*/
document.getElementById("conBot").disabled=true;
document.getElementById("endBot").disabled=true;
/*disable the next bottuns*/
if (isNestDis==1){
  document.getElementById("qBot").disabled=true;
  document.getElementById("skipR").disabled=true;
  document.getElementById("nextIsM").disabled=true;
  document.getElementById("nextSp").disabled=true;
}
/*trial variable*/
var totalStep = 0;
var in1R,in1L,inP,tar1,nSt,rowT,colT;

/*make display elements unseen*/
document.getElementById("cPic").style.display="none";
document.getElementById("tarPid").style.display="none";
document.getElementsByClassName("whichIsCloser")[0].style.display="none";
document.getElementsByClassName("navig")[0].style.display="none";
document.getElementsByClassName("global inst")[0].style.display="none";
document.getElementById("learnRandomWalk").style.display="none";
document.getElementById("learnRandomPairs").style.display="none";
document.getElementsByClassName("isMiddle")[0].style.display="none";
document.getElementsByClassName("pileDiv")[0].style.display="none";
document.getElementsByClassName("whichIsCloser_feedback")[0].style.display="none";
document.getElementById("Qfeedback").style.display="none";

var ndis = 1;
var subjectId;
/*array pictures objects - maps*/
var nmap=1;

function initMapsAndSetDisplay(){ // the first function to be called, formerly called starDisc()
  /* subject first name*/
  var subjectId0 = document.getElementById("subjectId").value;
  if(subjectId0.endsWith("\n")||subjectId0.endsWith(" ")){
    subjectId = subjectId0.slice(0,subjectId0.length - 1);
  }else{
    subjectId = subjectId0;
  }

  /*create/retrive MAPS and save in sql table*/
  var j1,j2,j3;
  var nodeStr, imgFileName; // nodeStr will be the names of the columns in SQL table ("node" + nodeNum), storing the file names of images in their order in he current graph. their tags are the indeces of the file names in imgFileNamesArr
  var nmmax,nodeNum;
  nmmax = maxMap;
  var nn,vn=[]; // vn: vector of numbers.
  var vn01=[];
  var vn1=[]; // this will be a vector with the filename numbers of images (e.g. 11 for the image of the file pic11.jpeg), in a random order
  for (j3=1;j3<=nall;j3++){
    vn01.push(j3); // vn01 is a vector 1:nall
  }
  nn = nall;// nall is the number of pictures in the directory

  // sample without replacement indeces for pictures, store in vn1
  for (j3=0;j3<=npmax;j3++){ // npmax is the length of the largest map of the experiment
    // get a random index between 1 and nall, and populate vn1 with it
    np0 = Math.floor(Math.random() * (nn));
    vn1.push(vn01[np0]);
    // discard the used random index
    vn01.splice(np0, 1);
    nn = nn-1;
  }
  nn = npmax;

  // check if the images array already exists. If it does, return it in an array .
  // If it doesn't, return -1
  imgFileNamesArr = checkIfSubjectMapExists(subjectId);
  // If images array does not exist, create it (randomely assign images files to graph nodes - i.e. the emissions matrix)
  if (imgFileNamesArr[0]==-1){ // does not exists
    imgFileNamesArr=[];
    for (j1=0; j1<npmax;j1++){
      nn = nn-1;
      nodeNum = j1+1;
      nodeStr = "node" + nodeNum; // these will be the names of the columns in the SQL table, where the img files will be filled.
      imgFileName = "pic" + vn1[j1].toString() + ".jpg"
      imgFileNamesArr.push(imgFileName);
      // save to SQL. vn1[j1] is the filenameTag saved in the images folders, e.g. "pic" + filenameTag + ".jpg"
      save2imagesFilesTable(imgFileName,nodeStr); // in ajaxFunctions.js
      // discard the number already used
      vn.splice(np0, 1);
    }
  }
  if (vn.length>0){ // Alon: I don't really understand why you need to do this - you don't use vn again.
    clear1dArr(vn);
  }

  save2subjectDetailsAndStartTimeTable(subjectId);

  /* change display */
  document.getElementById("startDiv").style.display="none";
  document.getElementsByClassName("global inst")[0].style.display="inline";
  document.getElementById("startTb").style.display="inline";
  document.getElementsByClassName("endTask")[0].style.display="none";
  document.getElementById("picT").style.display="inline";
  /* general instructions - the instructions that appears at the start page*/
  document.getElementById("inst1").innerHTML="<b>Task description</b>:<br> We are playing a card memory game. Each picture is a card. <br> The task is divided into rounds, on each rounds there are 5 parts. <br> Today you will learn two pictures sets. <br> The first part is a learning phase. If the pictures are from a new set of pictures, a red message will appear on the screen. <br> If the pictures belong to the same pictures sets as in the previouse round of games there will be a green message. <br> In each step you can lose/win coins. In some of the games you can see the coins you got on the right side of the screen.<br>Follow the instruction on each part of the game.";//<br>During the first part you will have to determine whether the picture is tilt or not,<br>pay attention to the pictures on the cards and the order in which they are presented, as it will help you in the following  tasks.";
  document.getElementById("targetPic").innerHTML="your target is:<br> ";

  //presPic();// for debugging, present all images
}

function presPic(){
  /*display the pictures array -  for debugging*/
  var disPic = 0;
  var j,picSrc,isLine,leftP,leftP0,rightP=0;
  var pathToImgDir = "/MEG/images/set1reg/";
  var imH = 120;
  var dpL = 20;
  var dpR = 20;
  leftP0 = Math.ceil(nCol/2)*imH;
  leftP = leftP0;
  document.write("<div class='dispPicArr'>");
  for(j=0;j<npmax;j++){
    picSrc = pathToImgDir+ imgFileNamesArr[j];
    document.write("<img border ='5px solid gray' height='"+imH+"'px width='"+imH+"px' position='relative' left="+leftP+"px right="+rightP+"px src='"+picSrc+">");
    isLine = Math.ceil((j+1)/nCol);
    isLine = (isLine)*nCol-j-1;
    leftP = leftP+dpL;
    if(isLine==0){
      document.write("<br>");
      leftP = leftP0;
      rightP = 0;
    }
  }
}

function checkIfSubjectMapExists(){
  var map=[]; // map is an array mapping image files to node numbers - imgFileNamesArr
  var j;
  var xhttp;
  xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      // if map exists, it is returned in a JSON str. if not, an empty str is returned.
      var data = JSON.parse(this.responseText);
      if(data.length==0){ //if map does not exist
        map[0]=-1;
      }else{ // if exists, build map array
        // loop through images. Start at 1 because the first column in data[0] is subjectId.
        for(j=1;j<=npmax;j++){
          map[j-1]=data[0][j]; // data[0] is a single row of SQL table, j indexes it.
        }
      }
    }
  };
  xhttp.open("GET", "checkIfSubjectMapExists.php?q="+subjectId, false);
  xhttp.send();
  return map;
}

function choosePart(){ // find the task's part in which particpants played with before taking a break. This is only called at the beginning of the session.
  var n;
  var completedRunsPerTask=[];

  // Alon: check if can converge learnRandomWalkTable learnRandomPairsTable to one table

  completedRunsPerTask[0] = getRunNumFromTable("learnRandomWalkTable",subjectId); // function getRunNumFromTable is in ajaxFunctions.js, getRunNumFromTable gives the current run of each task
  completedRunsPerTask[1] = getRunNumFromTable("isInPileTable",subjectId);
  completedRunsPerTask[2] = getRunNumFromTable("isMiddleTable",subjectId);
  completedRunsPerTask[3] = getRunNumFromTable("navigTable",subjectId);
  completedRunsPerTask[4] = getRunNumFromTable("whichIsCloserTable",subjectId);

  var maxRunsPerTask = maxArr(completedRunsPerTask); // this is where the subject stopped

  /* change display*/
  document.getElementsByClassName("isMiddle")[0].style.display="none"; // hide isMiddle html elements
  document.getElementsByClassName("navig")[0].style.display="none"; // hide navigation task html elements
  document.getElementsByClassName("global inst")[0].style.display="none"; // hide global instructions html elements
  ncoinT = 0; // how may coins collected until now
  if(completedRunsPerTask[0]==0){ // learning phase
    task.curRun  = 1; // global that counts the runs - how many times did all the blocks/tasks complete.
    learnRandomWalkTask();
  }else{
    task.curRun = maxRunsPerTask; // task.curRun global that counts the runs - how many times did all the blocks/tasks complete.
    curMp = task.mapsVec[task.curRun-1]; // current map (-1 because task.curRun starts at 1 and indeces start at 0)
    if (task.curRun>1){
      curMpLast = task.mapsVec[task.curRun-2]; // curMpLast is the map before current one, perhaps can delete
    }else{
      curMpLast = -1;
    }

    // from here, go backwards in the order of tasks, and check where tehe suject stopped

    if(completedRunsPerTask[4]==maxRunsPerTask){
      // if the connection was terminated in the midle of a task, start again from the last trial
      numQ = getTrialNumFromTable("whichIsCloserTable",subjectId); //read the number of questions that was asked in the current block from the table of the distance estimation task - from sql
      ncoin=numCoin("whichIsCloserTable",subjectId); // check the number of coines that was earned until now
      if (numQ<qend){// continue distance estimation task
        numCorrect = calCorQ("whichIsCloserTable",subjectId);// number of correct answers
        defineGraph();
        startWhichIsCloser(numQ);
      }else{// start learning phase of the next run
        task.curRun = task.curRun+1;
        if(task.curRun>8){// 8 learning trials on day 1, then start inference part
          learnRandomPairsTask();// learning from pairs
        }else{
          learnRandomWalkTask();// learning from random walk
        }
      }
    }else{

      if (completedRunsPerTask[3]==maxRunsPerTask){
        defineGraph();
        if(task.curRun<9){ // Navigation task only happens in the first 8 runs because from run 9 onwards we only learn from pairs and selected piles.
          cds = TaskdS(subjectId); // TaskdS: find the last initial distnace in navigation task.
          if (cds == maxdS){// start distance estimation questions
            numQ=0;
            startWhichIsCloser(numQ);
          }else{// continue with navigation task
            ncoin=numCoin("navigTable",subjectId);
            var ntn = getTrialNumFromTable("navigTable",subjectId);
            repTmis = Math.floor(ntn/numdS); // delete? check if used
            startNavigTask(cds+1);
          }
        }else{
          startWhichIsCloser(0);
        }
      }else{ // maxRunsPerTask was not whichIsCloser and not Navigation
        if(completedRunsPerTask[2]==maxRunsPerTask){// go to is it in the middle part
          nrep=getTrialNumFromTable("isMiddleTable",subjectId);
          ncoin=numCoin("isMiddleTable",subjectId);
          defineGraph();
          if(nrep<maxIsM){
            isItMiddle(0);
          }else{
            if(task.curRun<9){
              startNavigTask(2);
            }else{
              startWhichIsCloser(0);
            }
          }

        }else{
          if(completedRunsPerTask[1]==maxRunsPerTask){// go to which pile part
            thisT = getTrialNumFromTable("isInPileTable",subjectId);// read the number of trials that the subject have allready played in this block from the sql table
            ncoin=numCoin("isInPileTable",subjectId);
            defineGraph();
            if(thisT<maxPile){
              whichPile(0);
            }else{
              isItMiddle(1);
            }
          }else{// continue phase learning task
            ncoin=numCoin("navigTable",subjectId);
            if (maxRunsPerTask>8){
              thisTC = getTrialNumFromTable("learnRandomPairsTable",subjectId);
              learnRandomPairsTask(thisTC);// learning from pairs
            }else{
              thisTC = getTrialNumFromTable("learnRandomWalkTable",subjectId);
              learnRandomWalkTask(thisTC); //learning from random walk (consecutive pairs)
            }
          }
        }
      }
    }
  }

}
function chooseLearning_walkOrPairs(){ // formerly called chooseCoverStaff
  if (task.curRun>8){
    learnRandomPairsTask(0);
  }else{
    learnRandomWalkTask(0);
  }
}


</script>


</body>
</html>
